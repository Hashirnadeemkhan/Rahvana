<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Expert Consultation | Rahvana</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --color-primary: #0d9488;
            --color-primary-dark: #0f766e;
            --color-primary-light: #5eead4;
            --color-primary-bg: #f0fdfa;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-text-light: #94a3b8;
            --color-bg: #ffffff;
            --color-bg-subtle: #f8fafc;
            --color-border: #e2e8f0;
            --color-border-focus: #0d9488;
            --color-error: #dc2626;
            --color-error-bg: #fef2f2;
            --color-success: #16a34a;
            --color-success-bg: #f0fdf4;
            --color-warning: #d97706;
            --color-warning-bg: #fffbeb;
            --color-info: #0284c7;
            --color-info-bg: #f0f9ff;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition-fast: 150ms ease;
            --transition-base: 200ms ease;
        }
        [dir="rtl"] { direction: rtl; text-align: right; }
        html { font-size: 16px; }
        body { font-family: var(--font-sans); font-size: var(--font-size-base); line-height: 1.6; color: var(--color-text); background: var(--color-bg-subtle); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: var(--space-lg); }
        .hidden { display: none !important; }
        .icon { width: 20px; height: 20px; flex-shrink: 0; }
        .icon-sm { width: 16px; height: 16px; }
/* Header */
        .header { background: var(--color-bg); border-bottom: 1px solid var(--color-border); padding: var(--space-md) var(--space-lg); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-primary); text-decoration: none; }
        .header-actions { display: flex; align-items: center; gap: var(--space-md); }
        .direction-toggle { display: flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-bg); color: var(--color-text-muted); font-size: var(--font-size-sm); cursor: pointer; }
        .direction-toggle:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .nav-link { color: var(--color-text-muted); text-decoration: none; font-size: var(--font-size-sm); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-sm); }
        .nav-link:hover, .nav-link.active { color: var(--color-primary); background: var(--color-primary-bg); }
        
        /* Ribbon */
        .services-ribbon { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); padding: var(--space-lg) var(--space-xl); color: white; }
        .ribbon-content { max-width: 800px; margin: 0 auto; text-align: center; }
        .ribbon-title { font-size: var(--font-size-2xl); font-weight: 700; margin-bottom: var(--space-sm); }
        .ribbon-subtitle { opacity: 0.9; }
        
        /* Card */
        .card { background: var(--color-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); overflow: hidden; }
        .card-header { padding: var(--space-lg); border-bottom: 1px solid var(--color-border); }
        .card-body { padding: var(--space-lg); }
        
        /* Progress */
        .progress-container { padding: var(--space-lg); background: var(--color-bg-subtle); }
        .progress-steps { display: flex; justify-content: center; align-items: center; gap: var(--space-sm); max-width: 500px; margin: 0 auto; }
        .progress-step { display: flex; align-items: center; gap: var(--space-sm); }
        .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-sm); font-weight: 600; background: var(--color-border); color: var(--color-text-muted); }
        .step-number.active { background: var(--color-primary); color: white; }
        .step-number.completed { background: var(--color-success); color: white; }
        .step-label { font-size: var(--font-size-sm); color: var(--color-text-muted); display: none; }
        @media (min-width: 640px) { .step-label { display: block; } }
        .step-label.active { color: var(--color-primary); font-weight: 500; }
        .progress-line { flex: 1; height: 2px; background: var(--color-border); max-width: 60px; }
        .progress-line.completed { background: var(--color-success); }
/* Form Elements */
        .form-group { margin-bottom: var(--space-lg); }
        .form-label { display: block; font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text); margin-bottom: var(--space-sm); }
        .form-label .required { color: var(--color-error); }
        .form-hint { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-xs); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--font-size-base); font-family: inherit; color: var(--color-text); background: var(--color-bg); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--color-border-focus); box-shadow: 0 0 0 3px var(--color-primary-bg); }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px; }
        [dir="rtl"] .form-select { background-position: left 12px center; padding-right: var(--space-md); padding-left: 40px; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr; gap: var(--space-md); }
        @media (min-width: 640px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .checkbox-group { display: flex; align-items: flex-start; gap: var(--space-sm); }
        .checkbox-input { width: 18px; height: 18px; margin-top: 2px; cursor: pointer; accent-color: var(--color-primary); }
        .checkbox-label { font-size: var(--font-size-sm); color: var(--color-text-muted); cursor: pointer; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-lg); border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: 500; cursor: pointer; transition: all var(--transition-fast); text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--color-primary-dark); }
        .btn-secondary { background: var(--color-bg); color: var(--color-text); border: 1px solid var(--color-border); }
        .btn-secondary:hover:not(:disabled) { background: var(--color-bg-subtle); }
        .btn-lg { padding: var(--space-md) var(--space-xl); font-size: var(--font-size-lg); }
        .btn-sm { padding: var(--space-xs) var(--space-md); font-size: var(--font-size-sm); }
        .form-footer { display: flex; justify-content: space-between; align-items: center; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); margin-top: var(--space-lg); }
/* Slot Picker */
        .slot-picker { border: 1px solid var(--color-border); border-radius: var(--radius-lg); overflow: hidden; }
        .slot-picker-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); background: var(--color-bg-subtle); border-bottom: 1px solid var(--color-border); }
        .slot-picker-title { font-weight: 600; color: var(--color-text); }
        .slot-picker-nav { display: flex; gap: var(--space-sm); }
        .slot-picker-nav-btn { width: 32px; height: 32px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .slot-picker-nav-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .slot-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-border); }
        .slot-day { background: var(--color-bg); padding: var(--space-sm); min-height: 100px; }
        .slot-day-header { text-align: center; padding-bottom: var(--space-sm); border-bottom: 1px solid var(--color-border); margin-bottom: var(--space-sm); }
        .slot-day-name { font-size: var(--font-size-xs); color: var(--color-text-muted); text-transform: uppercase; }
        .slot-day-date { font-size: var(--font-size-lg); font-weight: 600; color: var(--color-text); }
        .slot-day.today .slot-day-date { color: var(--color-primary); }
        .slot-times { display: flex; flex-direction: column; gap: var(--space-xs); }
        .slot-time { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-bg); cursor: pointer; text-align: center; }
        .slot-time:hover { border-color: var(--color-primary); background: var(--color-primary-bg); }
        .slot-time.selected { background: var(--color-primary); border-color: var(--color-primary); color: white; }
        .slot-time.unavailable { opacity: 0.4; cursor: not-allowed; text-decoration: line-through; }
        .slot-time.pending { background: var(--color-warning-bg); border-color: var(--color-warning); color: var(--color-warning); }
        @media (max-width: 768px) {
            .slot-days { grid-template-columns: 1fr; }
            .slot-day { display: flex; align-items: center; gap: var(--space-md); min-height: auto; padding: var(--space-md); }
            .slot-day-header { min-width: 60px; border-bottom: none; padding-bottom: 0; margin-bottom: 0; text-align: left; }
            .slot-times { flex-direction: row; flex-wrap: wrap; flex: 1; }
        }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); font-weight: 500; border-radius: var(--radius-sm); text-transform: uppercase; }
        .badge-pending { background: var(--color-warning-bg); color: var(--color-warning); }
        .badge-confirmed { background: var(--color-success-bg); color: var(--color-success); }
        .badge-completed { background: #e0e7ff; color: #3730a3; }
        .badge-canceled { background: var(--color-error-bg); color: var(--color-error); }
        .badge-info { background: var(--color-info-bg); color: var(--color-info); }
        .badge-alternatives { background: #fef3c7; color: #92400e; }
/* File Upload */
        .file-upload { border: 2px dashed var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); text-align: center; cursor: pointer; }
        .file-upload:hover { border-color: var(--color-primary); background: var(--color-primary-bg); }
        .file-upload-icon { width: 48px; height: 48px; margin: 0 auto var(--space-md); color: var(--color-text-muted); }
        .file-upload-text { color: var(--color-text-muted); font-size: var(--font-size-sm); }
        .file-list { margin-top: var(--space-md); }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm) var(--space-md); background: var(--color-bg-subtle); border-radius: var(--radius-sm); margin-bottom: var(--space-xs); }
        .file-item-name { font-size: var(--font-size-sm); color: var(--color-text); display: flex; align-items: center; gap: var(--space-sm); }
        .file-item-remove { color: var(--color-text-muted); cursor: pointer; padding: var(--space-xs); }
        .file-item-remove:hover { color: var(--color-error); }
        
        /* Confirmation */
        .confirmation { text-align: center; padding: var(--space-2xl) var(--space-lg); }
        .confirmation-icon { width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--color-success-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--color-success); }
        .confirmation-title { font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-text); margin-bottom: var(--space-sm); }
        .confirmation-message { color: var(--color-text-muted); margin-bottom: var(--space-lg); }
        .confirmation-id { display: inline-block; padding: var(--space-sm) var(--space-lg); background: var(--color-bg-subtle); border-radius: var(--radius-md); font-family: monospace; font-size: var(--font-size-lg); margin-bottom: var(--space-lg); }
        
        /* Requests List */
        .requests-list { display: flex; flex-direction: column; gap: var(--space-md); }
        .request-card { border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); background: var(--color-bg); cursor: pointer; }
        .request-card:hover { border-color: var(--color-primary); box-shadow: var(--shadow-sm); }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-sm); }
        .request-id { font-family: monospace; font-size: var(--font-size-sm); color: var(--color-text-muted); }
        .request-card-body { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); font-size: var(--font-size-sm); }
        @media (min-width: 640px) { .request-card-body { grid-template-columns: repeat(4, 1fr); } }
        .request-field-label { color: var(--color-text-muted); font-size: var(--font-size-xs); }
        .request-field-value { color: var(--color-text); }
        
        /* Detail Section */
        .detail-section { margin-bottom: var(--space-lg); padding-bottom: var(--space-lg); border-bottom: 1px solid var(--color-border); }
        .detail-section:last-child { border-bottom: none; }
        .detail-section-title { font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text); margin-bottom: var(--space-md); text-transform: uppercase; }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); }
        @media (min-width: 640px) { .detail-grid { grid-template-columns: repeat(3, 1fr); } }
        .detail-item-label { color: var(--color-text-muted); margin-bottom: var(--space-xs); font-size: var(--font-size-sm); }
        .detail-item-value { color: var(--color-text); font-weight: 500; }
        
        /* Timeline */
        .timeline { position: relative; padding-left: var(--space-lg); }
        .timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: var(--color-border); }
        .timeline-item { position: relative; padding-bottom: var(--space-md); }
        .timeline-dot { position: absolute; left: calc(-1 * var(--space-lg) + 2px); width: 10px; height: 10px; background: var(--color-border); border-radius: 50%; border: 2px solid var(--color-bg); }
        .timeline-dot.active { background: var(--color-primary); }
        .timeline-date { color: var(--color-text-muted); font-size: var(--font-size-xs); }
        .timeline-text { color: var(--color-text); font-size: var(--font-size-sm); }
        
        /* Alternatives */
        .alternatives-section { background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg); }
        .alternatives-title { font-weight: 600; color: var(--color-warning); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm); }
        .alternative-slots { display: flex; flex-wrap: wrap; gap: var(--space-sm); }
        .alternative-slot { padding: var(--space-sm) var(--space-md); border: 2px solid transparent; border-radius: var(--radius-md); background: var(--color-bg); cursor: pointer; text-align: center; }
        .alternative-slot:hover { border-color: var(--color-primary); }
        .alternative-slot.selected { border-color: var(--color-primary); background: var(--color-primary-bg); }
        
        /* Messages */
        .message-box { background: var(--color-info-bg); border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-md); }
        .message-box-title { font-weight: 600; color: var(--color-info); margin-bottom: var(--space-sm); }
        .message-box-content { font-size: var(--font-size-sm); color: var(--color-text); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: var(--space-lg); z-index: 1000; opacity: 0; visibility: hidden; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--color-bg); border-radius: var(--radius-lg); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg); border-bottom: 1px solid var(--color-border); }
        .modal-title { font-size: var(--font-size-lg); font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border: none; background: transparent; cursor: pointer; color: var(--color-text-muted); display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
        .modal-close:hover { background: var(--color-bg-subtle); }
        .modal-body { padding: var(--space-lg); }
        
        /* Empty State */
        .empty-state { text-align: center; padding: var(--space-2xl); color: var(--color-text-muted); }
        .empty-state-icon { width: 64px; height: 64px; margin: 0 auto var(--space-md); opacity: 0.5; }
        .empty-state-title { font-size: var(--font-size-lg); font-weight: 600; color: var(--color-text); margin-bottom: var(--space-sm); }
        .mt-md { margin-top: var(--space-md); }
        .mb-md { margin-bottom: var(--space-md); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease; }
    </style>
</head>
<body>
<!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">Rahvana</a>
            <div class="header-actions">
                <a href="#" class="nav-link active" data-view="booking">Book Consultation</a>
                <a href="#" class="nav-link" data-view="requests">My Requests</a>
                <button class="direction-toggle" onclick="toggleDirection()">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12H3M21 12L15 6M21 12L15 18M3 12L9 6M3 12L9 18"/></svg>
                    <span id="dir-label">LTR</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Services Ribbon -->
    <div class="services-ribbon" id="booking-ribbon">
        <div class="ribbon-content">
            <h1 class="ribbon-title">Book Expert Consultation</h1>
            <p class="ribbon-subtitle">Get personalized guidance for your U.S. immigration journey</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Booking View -->
        <div id="booking-view">
            <div class="card">
                <!-- Progress Steps -->
                <div class="progress-container">
                    <div class="progress-steps">
                        <div class="progress-step">
                            <div class="step-number active" id="step-1-num">1</div>
                            <span class="step-label active" id="step-1-label">Case Details</span>
                        </div>
                        <div class="progress-line" id="line-1-2"></div>
                        <div class="progress-step">
                            <div class="step-number" id="step-2-num">2</div>
                            <span class="step-label" id="step-2-label">Contact Info</span>
                        </div>
                        <div class="progress-line" id="line-2-3"></div>
                        <div class="progress-step">
                            <div class="step-number" id="step-3-num">3</div>
                            <span class="step-label" id="step-3-label">Select Time</span>
                        </div>
                    </div>
                </div>
<!-- Step 1: Case Details -->
                <div class="card-body" id="step-1">
                    <div class="form-group">
                        <label class="form-label">Issue Category <span class="required">*</span></label>
                        <select class="form-select" id="issue-category" required>
                            <option value="">Select an issue category...</option>
                            <optgroup label="Petition & Application Filing">
                                <option value="i130-preparation">I-130 Petition Preparation</option>
                                <option value="i129f-petition">I-129F (K-1 Fiance) Petition</option>
                                <option value="filing-strategy">Filing Strategy (AOS vs. Consular)</option>
                                <option value="priority-date">Priority Date Questions</option>
                            </optgroup>
                            <optgroup label="Document Preparation & Evidence">
                                <option value="birth-certificate">Birth Certificate Issues (NADRA)</option>
                                <option value="marriage-certificate">Marriage Certificate Authentication</option>
                                <option value="police-clearance">Police Clearance Certificates</option>
                                <option value="translation">Document Translation & Certification</option>
                                <option value="bona-fide-evidence">Evidence of Bona Fide Relationship</option>
                                <option value="financial-docs">Financial Documentation</option>
                            </optgroup>
                            <optgroup label="NVC Processing">
                                <option value="nvc-welcome">NVC Welcome Letter/Case Creation</option>
                                <option value="ds260">DS-260 Completion & Submission</option>
                                <option value="i864">I-864 Affidavit of Support</option>
                                <option value="nvc-fees">NVC Fee Payment Issues</option>
                                <option value="dq-status">Documentarily Qualified Status</option>
                            </optgroup>
                            <optgroup label="Embassy Interview & Processing">
                                <option value="interview-scheduling">Interview Appointment Scheduling</option>
                                <option value="interview-prep">Interview Preparation</option>
                                <option value="medical-exam">Medical Examination</option>
                                <option value="interview-outcome">Interview Outcome Explanation</option>
                            </optgroup>
                            <optgroup label="Administrative Processing & 221(g)">
                                <option value="221g-white">221(g) White Slip (Documents Missing)</option>
                                <option value="221g-blue">221(g) Blue/Pink Slip (Background Check)</option>
                                <option value="ap-timeline">Administrative Processing Timeline</option>
                                <option value="ceac-status">CEAC Status Interpretation</option>
                            </optgroup>
                            <optgroup label="Financial Sponsorship">
                                <option value="income-requirements">I-864 Income Requirements</option>
                                <option value="joint-sponsor">Joint Sponsor Requirements</option>
                                <option value="public-charge">Public Charge Considerations</option>
                            </optgroup>
                            <optgroup label="Visa Bulletin & Wait Times">
                                <option value="visa-bulletin">Visa Bulletin Interpretation</option>
                                <option value="retrogression">Category Retrogression</option>
                                <option value="aging-out">Aging Out & CSPA Protection</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Visa Category <span class="required">*</span></label>
                            <select class="form-select" id="visa-category" required>
                                <option value="">Select visa category...</option>
                                <optgroup label="Immediate Relatives">
                                    <option value="ir1-cr1">IR1/CR1 - Spouse of U.S. Citizen</option>
                                    <option value="ir2-cr2">IR2/CR2 - Child of U.S. Citizen</option>
                                    <option value="ir5">IR5 - Parent of U.S. Citizen</option>
                                </optgroup>
                                <optgroup label="Family Preference">
                                    <option value="f1">F1 - Unmarried Adult Child of USC</option>
                                    <option value="f2a">F2A - Spouse/Child of LPR</option>
                                    <option value="f2b">F2B - Unmarried Adult Child of LPR</option>
                                    <option value="f3">F3 - Married Child of USC</option>
                                    <option value="f4">F4 - Sibling of USC</option>
                                </optgroup>
                                <optgroup label="Fiance/Spousal">
                                    <option value="k1">K-1 - Fiance(e) of USC</option>
                                    <option value="k2">K-2 - Child of K-1 Holder</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="dv">DV - Diversity Visa</option>
                                    <option value="other">Other / Not Sure</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Case Stage <span class="required">*</span></label>
                            <select class="form-select" id="case-stage" required>
                                <option value="">Select current stage...</option>
                                <optgroup label="USCIS Phase">
                                    <option value="pre-filing">Pre-Filing / Planning</option>
                                    <option value="petition-filed">Petition Filed</option>
                                    <option value="rfe-received">RFE Received</option>
                                    <option value="petition-approved">Petition Approved</option>
                                </optgroup>
                                <optgroup label="NVC Phase">
                                    <option value="nvc-received">Case at NVC</option>
                                    <option value="ds260-submitted">DS-260 Submitted</option>
                                    <option value="dq">Documentarily Qualified</option>
                                    <option value="interview-scheduled">Interview Scheduled</option>
                                </optgroup>
                                <optgroup label="Embassy Phase">
                                    <option value="pre-interview">Preparing for Interview</option>
                                    <option value="interview-completed">Interview Completed</option>
                                    <option value="221g-ap">221(g) / Admin Processing</option>
                                    <option value="visa-approved">Visa Approved</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Embassy / Consulate <span class="required">*</span></label>
                            <select class="form-select" id="embassy" required>
                                <option value="">Select embassy...</option>
                                <option value="islamabad" selected>U.S. Embassy Islamabad</option>
                                <option value="karachi">U.S. Consulate Karachi</option>
                                <option value="other">Other Country</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Urgency <span class="required">*</span></label>
                            <select class="form-select" id="urgency" required>
                                <option value="">Select urgency level...</option>
                                <option value="low">Low - General guidance</option>
                                <option value="medium">Medium - Deadline within 30 days</option>
                                <option value="high">High - Deadline within 7 days</option>
                                <option value="urgent">Urgent - Immediate help needed</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Preferred Language</label>
                        <select class="form-select" id="language">
                            <option value="english">English</option>
                            <option value="urdu">Urdu</option>
                            <option value="both">Both English & Urdu</option>
                        </select>
                    </div>

                    <div class="form-footer">
                        <div></div>
                        <button class="btn btn-primary" onclick="nextStep(2)">
                            Continue
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
<!-- Step 2: Contact Info -->
                <div class="card-body hidden" id="step-2">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name <span class="required">*</span></label>
                            <input type="text" class="form-input" id="full-name" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address <span class="required">*</span></label>
                            <input type="email" class="form-input" id="email" placeholder="your@email.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">WhatsApp Number <span class="required">*</span></label>
                        <input type="tel" class="form-input" id="whatsapp" placeholder="+92 XXX XXXXXXX" required>
                        <p class="form-hint">Include country code. We may contact you via WhatsApp.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Case Summary <span class="required">*</span></label>
                        <textarea class="form-textarea" id="case-summary" placeholder="Describe your situation and what you need help with. Include relevant dates, case numbers, and questions." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Attachments (Optional)</label>
                        <div class="file-upload" onclick="simulateFileUpload()">
                            <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16V4M12 4L8 8M12 4L16 8"/><path d="M20 16.8V18.8C20 19.9 19.1 20.8 18 20.8H6C4.9 20.8 4 19.9 4 18.8V16.8"/></svg>
                            <p class="file-upload-text">Click to add files (notices, letters, forms)</p>
                        </div>
                        <div class="file-list" id="file-list"></div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" class="checkbox-input" id="consent" required>
                            <label class="checkbox-label" for="consent">I consent to being contacted via email and WhatsApp. I understand this consultation provides general guidance and does not constitute legal advice.</label>
                        </div>
                    </div>

                    <div class="form-footer">
                        <button class="btn btn-secondary" onclick="prevStep(1)">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                            Back
                        </button>
                        <button class="btn btn-primary" onclick="nextStep(3)">
                            Continue
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Select Time -->
                <div class="card-body hidden" id="step-3">
                    <p class="mb-md" style="color: var(--color-text-muted);">Select your preferred consultation time. Your appointment will be "Pending Approval" until confirmed.</p>

                    <div class="slot-picker">
                        <div class="slot-picker-header">
                            <span class="slot-picker-title" id="week-range">Loading...</span>
                            <div class="slot-picker-nav">
                                <button class="slot-picker-nav-btn" onclick="prevWeek()">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                                </button>
                                <button class="slot-picker-nav-btn" onclick="nextWeek()">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="slot-days" id="slot-days"></div>
                    </div>

                    <div class="form-group mt-md" id="selected-slot-display" style="display: none;">
                        <div style="padding: var(--space-md); background: var(--color-primary-bg); border-radius: var(--radius-md); border: 1px solid var(--color-primary);">
                            <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary);">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
                                <span style="font-weight: 500;">Selected Time:</span>
                                <span id="selected-slot-text"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-footer">
                        <button class="btn btn-secondary" onclick="prevStep(2)">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                            Back
                        </button>
                        <button class="btn btn-primary btn-lg" id="submit-btn" onclick="submitRequest()" disabled>
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/></svg>
                            Submit Request
                        </button>
                    </div>
                </div>

                <!-- Confirmation Screen -->
                <div class="card-body hidden" id="confirmation">
                    <div class="confirmation slide-up">
                        <div class="confirmation-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
                        </div>
                        <h2 class="confirmation-title">Request Submitted!</h2>
                        <p class="confirmation-message">Your consultation request has been received. Our team will review and confirm your appointment.</p>
                        <div class="confirmation-id" id="confirmation-id">RHV-XXXXXX</div>
                        <p style="margin-bottom: var(--space-lg);"><span class="badge badge-pending">Pending Approval</span></p>
                        <div style="display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="viewMyRequests()">View My Requests</button>
                            <button class="btn btn-secondary" onclick="startNewRequest()">Book Another</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!-- My Requests View -->
        <div id="requests-view" class="hidden">
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: var(--font-size-lg); font-weight: 600;">My Consultation Requests</h2>
                    <button class="btn btn-primary btn-sm" onclick="showBookingView()">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        New Request
                    </button>
                </div>
                <div class="card-body">
                    <div class="requests-list" id="requests-list"></div>
                    <div class="empty-state hidden" id="empty-requests">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                        <p class="empty-state-title">No requests yet</p>
                        <p>Book your first consultation to get started.</p>
                        <button class="btn btn-primary mt-md" onclick="showBookingView()">Book Consultation</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Request Detail Modal -->
    <div class="modal-overlay" id="request-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Request Details</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="modal-body" id="request-detail-content"></div>
        </div>
    </div>
<script>
        // Storage keys - shared with admin portal
        const STORAGE_KEY = 'rahvana_consultation_requests';
        const AVAILABILITY_KEY = 'rahvana_availability';

        let currentStep = 1;
        let currentWeekStart = new Date();
        let selectedSlot = null;
        let mockFiles = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeAvailability();
            currentWeekStart = getMonday(new Date());
            renderSlotPicker();
            loadRequests();

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.dataset.view;
                    if (view === 'booking') showBookingView();
                    else if (view === 'requests') viewMyRequests();
                });
            });
        });

        // RTL Toggle
        function toggleDirection() {
            const html = document.documentElement;
            const label = document.getElementById('dir-label');
            if (html.dir === 'rtl') {
                html.dir = 'ltr';
                label.textContent = 'LTR';
            } else {
                html.dir = 'rtl';
                label.textContent = 'RTL';
            }
        }

        // Availability Management
        function initializeAvailability() {
            let availability = localStorage.getItem(AVAILABILITY_KEY);
            if (!availability) {
                const slots = {};
                const times = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00'];
                const today = new Date();
                for (let i = 0; i < 14; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateStr = formatDateKey(date);
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    slots[dateStr] = {};
                    times.forEach(time => {
                        slots[dateStr][time] = Math.random() > 0.2 ? 'available' : 'unavailable';
                    });
                }
                localStorage.setItem(AVAILABILITY_KEY, JSON.stringify(slots));
            }
        }

        function getAvailability() {
            const data = localStorage.getItem(AVAILABILITY_KEY);
            return data ? JSON.parse(data) : {};
        }

        function updateSlotStatus(dateStr, time, status) {
            const availability = getAvailability();
            if (!availability[dateStr]) availability[dateStr] = {};
            availability[dateStr][time] = status;
            localStorage.setItem(AVAILABILITY_KEY, JSON.stringify(availability));
        }

        // Date Utilities
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDisplayDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatFullDate(date) {
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }

        function getDayName(date) {
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        function formatTime12h(time) {
            const [hours] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`;
        }
// Slot Picker Rendering
        function renderSlotPicker() {
            const container = document.getElementById('slot-days');
            const weekRange = document.getElementById('week-range');
            const availability = getAvailability();
            const times = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00'];

            container.innerHTML = '';

            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            weekRange.textContent = `${formatDisplayDate(currentWeekStart)} - ${formatDisplayDate(weekEnd)}, ${currentWeekStart.getFullYear()}`;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                const dateStr = formatDateKey(date);
                const isToday = date.getTime() === today.getTime();
                const isPast = date < today;
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                const dayEl = document.createElement('div');
                dayEl.className = `slot-day${isToday ? ' today' : ''}`;

                const daySlots = availability[dateStr] || {};
                let slotsHtml = '';

                if (!isWeekend && !isPast) {
                    times.forEach(time => {
                        const status = daySlots[time] || 'unavailable';
                        const isSelected = selectedSlot && selectedSlot.date === dateStr && selectedSlot.time === time;
                        let slotClass = 'slot-time';

                        if (status === 'unavailable' || status === 'confirmed') {
                            slotClass += ' unavailable';
                        } else if (status === 'pending') {
                            slotClass += ' pending';
                        } else if (isSelected) {
                            slotClass += ' selected';
                        }

                        const clickable = status === 'available' || isSelected;
                        slotsHtml += `<div class="${slotClass}" ${clickable ? `onclick="selectSlot('${dateStr}', '${time}')"` : ''}>${formatTime12h(time)}</div>`;
                    });
                } else if (isWeekend) {
                    slotsHtml = '<div style="font-size:var(--font-size-xs);color:var(--color-text-light);text-align:center;padding:var(--space-sm);">Closed</div>';
                } else {
                    slotsHtml = '<div style="font-size:var(--font-size-xs);color:var(--color-text-light);text-align:center;padding:var(--space-sm);">Past</div>';
                }

                dayEl.innerHTML = `
                    <div class="slot-day-header">
                        <div class="slot-day-name">${getDayName(date)}</div>
                        <div class="slot-day-date">${date.getDate()}</div>
                    </div>
                    <div class="slot-times">${slotsHtml}</div>
                `;
                container.appendChild(dayEl);
            }
        }

        function selectSlot(date, time) {
            if (selectedSlot && selectedSlot.date === date && selectedSlot.time === time) {
                selectedSlot = null;
                document.getElementById('selected-slot-display').style.display = 'none';
                document.getElementById('submit-btn').disabled = true;
            } else {
                selectedSlot = { date, time };
                const dateObj = new Date(date + 'T00:00:00');
                document.getElementById('selected-slot-text').textContent = `${formatFullDate(dateObj)} at ${formatTime12h(time)}`;
                document.getElementById('selected-slot-display').style.display = 'block';
                document.getElementById('submit-btn').disabled = false;
            }
            renderSlotPicker();
        }

        function prevWeek() {
            const today = getMonday(new Date());
            const newStart = new Date(currentWeekStart);
            newStart.setDate(newStart.getDate() - 7);
            if (newStart >= today) {
                currentWeekStart = newStart;
                renderSlotPicker();
            }
        }

        function nextWeek() {
            const today = getMonday(new Date());
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 14);
            const newStart = new Date(currentWeekStart);
            newStart.setDate(newStart.getDate() + 7);
            if (newStart < maxDate) {
                currentWeekStart = newStart;
                renderSlotPicker();
            }
        }
// Wizard Navigation
        function nextStep(step) {
            if (!validateStep(currentStep)) return;
            currentStep = step;
            updateStepDisplay();
        }

        function prevStep(step) {
            currentStep = step;
            updateStepDisplay();
        }

        function validateStep(step) {
            if (step === 1) {
                const fields = ['issue-category', 'visa-category', 'case-stage', 'embassy', 'urgency'];
                for (const id of fields) {
                    if (!document.getElementById(id).value) {
                        alert('Please fill in all required fields.');
                        return false;
                    }
                }
            } else if (step === 2) {
                const fullName = document.getElementById('full-name').value.trim();
                const email = document.getElementById('email').value.trim();
                const whatsapp = document.getElementById('whatsapp').value.trim();
                const caseSummary = document.getElementById('case-summary').value.trim();
                const consent = document.getElementById('consent').checked;

                if (!fullName || !email || !whatsapp || !caseSummary) {
                    alert('Please fill in all required fields.');
                    return false;
                }
                if (!consent) {
                    alert('Please agree to the consent checkbox.');
                    return false;
                }
                if (!email.includes('@')) {
                    alert('Please enter a valid email address.');
                    return false;
                }
            }
            return true;
        }

        function updateStepDisplay() {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                if (stepEl) stepEl.classList.toggle('hidden', i !== currentStep);
            }

            for (let i = 1; i <= 3; i++) {
                const numEl = document.getElementById(`step-${i}-num`);
                const labelEl = document.getElementById(`step-${i}-label`);
                const lineEl = document.getElementById(`line-${i}-${i+1}`);

                if (i < currentStep) {
                    numEl.classList.remove('active');
                    numEl.classList.add('completed');
                    numEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
                    labelEl.classList.remove('active');
                    if (lineEl) lineEl.classList.add('completed');
                } else if (i === currentStep) {
                    numEl.classList.add('active');
                    numEl.classList.remove('completed');
                    numEl.textContent = i;
                    labelEl.classList.add('active');
                } else {
                    numEl.classList.remove('active', 'completed');
                    numEl.textContent = i;
                    labelEl.classList.remove('active');
                    if (lineEl) lineEl.classList.remove('completed');
                }
            }

            if (currentStep === 3) renderSlotPicker();
        }

        // File Upload (Simulated)
        function simulateFileUpload() {
            const mockFileNames = ['NVC_Notice.pdf', 'I-797_Approval.pdf', '221g_Letter.pdf', 'Birth_Certificate.pdf', 'Passport_Copy.pdf'];
            const randomFile = mockFileNames[Math.floor(Math.random() * mockFileNames.length)];
            if (!mockFiles.includes(randomFile)) {
                mockFiles.push(randomFile);
                renderFileList();
            }
        }

        function renderFileList() {
            const container = document.getElementById('file-list');
            container.innerHTML = mockFiles.map((file, idx) => `
                <div class="file-item">
                    <span class="file-item-name">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                        ${file}
                    </span>
                    <span class="file-item-remove" onclick="removeFile(${idx})">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </span>
                </div>
            `).join('');
        }

        function removeFile(idx) {
            mockFiles.splice(idx, 1);
            renderFileList();
        }
// Request Submission
        function submitRequest() {
            if (!selectedSlot) {
                alert('Please select a time slot.');
                return;
            }

            const requestId = 'RHV-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const getVal = (id) => document.getElementById(id).value;
            const getLabel = (id) => {
                const sel = document.getElementById(id);
                return sel.options[sel.selectedIndex].text;
            };

            const request = {
                id: requestId,
                status: 'pending_approval',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                issueCategory: getVal('issue-category'),
                issueCategoryLabel: getLabel('issue-category'),
                visaCategory: getVal('visa-category'),
                visaCategoryLabel: getLabel('visa-category'),
                caseStage: getVal('case-stage'),
                caseStageLabel: getLabel('case-stage'),
                embassy: getVal('embassy'),
                embassyLabel: getLabel('embassy'),
                urgency: getVal('urgency'),
                urgencyLabel: getLabel('urgency'),
                language: getVal('language'),
                fullName: document.getElementById('full-name').value.trim(),
                email: document.getElementById('email').value.trim(),
                whatsapp: document.getElementById('whatsapp').value.trim(),
                caseSummary: document.getElementById('case-summary').value.trim(),
                attachments: [...mockFiles],
                requestedSlot: selectedSlot,
                confirmedSlot: null,
                alternativeSlots: [],
                timeline: [{ date: new Date().toISOString(), action: 'Request submitted', status: 'pending_approval' }],
                messages: []
            };

            const requests = getRequests();
            requests.push(request);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));

            updateSlotStatus(selectedSlot.date, selectedSlot.time, 'pending');

            document.getElementById('confirmation-id').textContent = requestId;
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                if (el.id.match(/^step-\d$/)) el.classList.add('hidden');
            });
            document.querySelector('.progress-container').classList.add('hidden');
            document.getElementById('confirmation').classList.remove('hidden');
        }

        // Request Management
        function getRequests() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function loadRequests() {
            const requests = getRequests();
            const container = document.getElementById('requests-list');
            const emptyState = document.getElementById('empty-requests');

            if (requests.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            container.innerHTML = requests.map(req => `
                <div class="request-card" onclick="openRequestDetail('${req.id}')">
                    <div class="request-card-header">
                        <span class="request-id">${req.id}</span>
                        ${getStatusBadge(req.status)}
                    </div>
                    <div class="request-card-body">
                        <div><div class="request-field-label">Issue</div><div class="request-field-value">${truncate(req.issueCategoryLabel, 25)}</div></div>
                        <div><div class="request-field-label">Visa Type</div><div class="request-field-value">${req.visaCategoryLabel}</div></div>
                        <div><div class="request-field-label">Requested Slot</div><div class="request-field-value">${formatSlotShort(req.requestedSlot)}</div></div>
                        <div><div class="request-field-label">Urgency</div><div class="request-field-value">${capitalize(req.urgency)}</div></div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'pending_approval': '<span class="badge badge-pending">Pending Approval</span>',
                'needs_more_info': '<span class="badge badge-info">Needs More Info</span>',
                'alternatives_proposed': '<span class="badge badge-alternatives">Alternatives Proposed</span>',
                'confirmed': '<span class="badge badge-confirmed">Confirmed</span>',
                'completed': '<span class="badge badge-completed">Completed</span>',
                'canceled': '<span class="badge badge-canceled">Canceled</span>'
            };
            return badges[status] || '<span class="badge badge-pending">Unknown</span>';
        }

        function truncate(str, len) { return str.length > len ? str.substring(0, len) + '...' : str; }
        function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1).replace(/_/g, ' '); }
        function formatSlotShort(slot) {
            if (!slot) return 'N/A';
            const date = new Date(slot.date + 'T00:00:00');
            return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${formatTime12h(slot.time)}`;
        }
        function formatSlotFull(slot) {
            if (!slot) return 'N/A';
            const date = new Date(slot.date + 'T00:00:00');
            return `${formatFullDate(date)} at ${formatTime12h(slot.time)}`;
        }
// Request Detail Modal
        function openRequestDetail(requestId) {
            const requests = getRequests();
            const request = requests.find(r => r.id === requestId);
            if (!request) return;

            const container = document.getElementById('request-detail-content');

            let alternativesHtml = '';
            if (request.status === 'alternatives_proposed' && request.alternativeSlots && request.alternativeSlots.length > 0) {
                alternativesHtml = `
                    <div class="alternatives-section">
                        <div class="alternatives-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                            Please Select an Alternative Time
                        </div>
                        <div class="alternative-slots" id="alt-slots">
                            ${request.alternativeSlots.map((slot, idx) => `
                                <div class="alternative-slot" onclick="selectAlternative('${requestId}', ${idx})" id="alt-${idx}">
                                    <div>${formatSlotShort(slot)}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-primary mt-md" onclick="confirmAlternative('${requestId}')" id="confirm-alt-btn" disabled>Confirm Selected Time</button>
                    </div>
                `;
            }

            let messagesHtml = '';
            if (request.messages && request.messages.length > 0) {
                messagesHtml = request.messages.map(msg => `
                    <div class="message-box">
                        <div class="message-box-title">Message from Admin - ${new Date(msg.date).toLocaleDateString()}</div>
                        <div class="message-box-content">${msg.text}</div>
                    </div>
                `).join('');
            }

            container.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg);">
                    <span class="request-id" style="font-size:var(--font-size-lg);">${request.id}</span>
                    ${getStatusBadge(request.status)}
                </div>
                ${alternativesHtml}
                ${messagesHtml}
                <div class="detail-section">
                    <h4 class="detail-section-title">Case Information</h4>
                    <div class="detail-grid">
                        <div><div class="detail-item-label">Issue</div><div class="detail-item-value">${request.issueCategoryLabel}</div></div>
                        <div><div class="detail-item-label">Visa Category</div><div class="detail-item-value">${request.visaCategoryLabel}</div></div>
                        <div><div class="detail-item-label">Case Stage</div><div class="detail-item-value">${request.caseStageLabel || 'N/A'}</div></div>
                        <div><div class="detail-item-label">Embassy</div><div class="detail-item-value">${request.embassyLabel}</div></div>
                        <div><div class="detail-item-label">Urgency</div><div class="detail-item-value">${request.urgencyLabel}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4 class="detail-section-title">Appointment</h4>
                    <div class="detail-grid">
                        <div><div class="detail-item-label">Requested</div><div class="detail-item-value">${formatSlotFull(request.requestedSlot)}</div></div>
                        ${request.confirmedSlot ? `<div><div class="detail-item-label">Confirmed</div><div class="detail-item-value" style="color:var(--color-success);font-weight:600;">${formatSlotFull(request.confirmedSlot)}</div></div>` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <h4 class="detail-section-title">Contact</h4>
                    <div class="detail-grid">
                        <div><div class="detail-item-label">Name</div><div class="detail-item-value">${request.fullName}</div></div>
                        <div><div class="detail-item-label">Email</div><div class="detail-item-value">${request.email}</div></div>
                        <div><div class="detail-item-label">WhatsApp</div><div class="detail-item-value">${request.whatsapp}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4 class="detail-section-title">Case Summary</h4>
                    <p style="color:var(--color-text);line-height:1.6;">${request.caseSummary}</p>
                </div>
                <div class="detail-section">
                    <h4 class="detail-section-title">Timeline</h4>
                    <div class="timeline">
                        ${request.timeline.map((item, idx) => `
                            <div class="timeline-item">
                                <div class="timeline-dot ${idx === 0 ? 'active' : ''}"></div>
                                <div><div class="timeline-date">${new Date(item.date).toLocaleString()}</div><div class="timeline-text">${item.action}</div></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('request-modal').classList.add('active');
        }

        let selectedAlternativeIdx = null;

        function selectAlternative(requestId, idx) {
            document.querySelectorAll('.alternative-slot').forEach(el => el.classList.remove('selected'));
            document.getElementById(`alt-${idx}`).classList.add('selected');
            selectedAlternativeIdx = idx;
            document.getElementById('confirm-alt-btn').disabled = false;
        }

        function confirmAlternative(requestId) {
            if (selectedAlternativeIdx === null) return;
            const requests = getRequests();
            const reqIdx = requests.findIndex(r => r.id === requestId);
            if (reqIdx === -1) return;

            const request = requests[reqIdx];
            const selectedAltSlot = request.alternativeSlots[selectedAlternativeIdx];

            if (request.requestedSlot) {
                updateSlotStatus(request.requestedSlot.date, request.requestedSlot.time, 'available');
            }

            request.confirmedSlot = selectedAltSlot;
            request.status = 'confirmed';
            request.updatedAt = new Date().toISOString();
            request.timeline.unshift({ date: new Date().toISOString(), action: 'User confirmed alternative slot', status: 'confirmed' });

            updateSlotStatus(selectedAltSlot.date, selectedAltSlot.time, 'confirmed');

            requests[reqIdx] = request;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));

            closeModal();
            loadRequests();
            alert('Your appointment has been confirmed!');
        }

        function closeModal() {
            document.getElementById('request-modal').classList.remove('active');
            selectedAlternativeIdx = null;
        }

        // View Navigation
        function viewMyRequests() {
            document.getElementById('booking-view').classList.add('hidden');
            document.getElementById('requests-view').classList.remove('hidden');
            document.getElementById('booking-ribbon').style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('[data-view="requests"]').classList.add('active');
            loadRequests();
        }

        function showBookingView() {
            document.getElementById('requests-view').classList.add('hidden');
            document.getElementById('booking-view').classList.remove('hidden');
            document.getElementById('booking-ribbon').style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('[data-view="booking"]').classList.add('active');
        }

        function startNewRequest() {
            currentStep = 1;
            selectedSlot = null;
            mockFiles = [];
            document.getElementById('confirmation').classList.add('hidden');
            document.querySelector('.progress-container').classList.remove('hidden');
            document.querySelectorAll('.form-input, .form-textarea').forEach(el => el.value = '');
            document.querySelectorAll('.form-select').forEach(el => el.selectedIndex = 0);
            document.getElementById('consent').checked = false;
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('selected-slot-display').style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
            updateStepDisplay();
        }
    </script>
</body>
</html>