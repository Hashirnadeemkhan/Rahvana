<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Portal | Rahvana</title>

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#0d9488;--primary-dark:#0f766e;--primary-bg:#f0fdfa;--text:#1e293b;--text-muted:#64748b;--text-light:#94a3b8;--bg:#fff;--bg-subtle:#f8fafc;--border:#e2e8f0;--error:#dc2626;--error-bg:#fef2f2;--success:#16a34a;--success-bg:#f0fdf4;--warning:#d97706;--warning-bg:#fffbeb;--info:#0284c7;--info-bg:#f0f9ff;--xs:0.25rem;--sm:0.5rem;--md:1rem;--lg:1.5rem;--xl:2rem;--font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;--text-xs:0.75rem;--text-sm:0.875rem;--text-base:1rem;--text-lg:1.125rem;--text-xl:1.25rem;--radius-sm:0.375rem;--radius-md:0.5rem;--radius-lg:0.75rem;--shadow:0 1px 3px rgba(0,0,0,0.1);--sidebar-w:240px}
    [dir="rtl"]{direction:rtl;text-align:right}
    html,body{height:100%}
    body{font-family:var(--font);font-size:var(--text-base);line-height:1.6;color:var(--text);background:var(--bg-subtle)}
    .hidden{display:none!important}
    .icon{width:20px;height:20px;flex-shrink:0}
    .icon-sm{width:16px;height:16px}

    .app{display:flex;min-height:100vh}

    .sidebar{width:var(--sidebar-w);background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:120;transform:translateX(0);transition:transform 200ms}
    [dir="rtl"] .sidebar{border-right:none;border-left:1px solid var(--border)}
    .sidebar-header{padding:var(--lg);border-bottom:1px solid var(--border)}
    .sidebar-logo{font-size:var(--text-xl);font-weight:700;color:var(--primary);text-decoration:none;display:block}
    .sidebar-sub{font-size:var(--text-xs);color:var(--text-muted);margin-top:var(--xs)}
    .sidebar-nav{flex:1;padding:var(--md)}
    .nav-item{display:flex;align-items:center;gap:var(--sm);padding:var(--sm) var(--md);border-radius:var(--radius-md);color:var(--text-muted);text-decoration:none;margin-bottom:var(--xs);cursor:pointer;border:none;background:none;width:100%;font-size:var(--text-sm);text-align:left}
    [dir="rtl"] .nav-item{text-align:right}
    .nav-item:hover{background:var(--bg-subtle);color:var(--text)}
    .nav-item.active{background:var(--primary-bg);color:var(--primary);font-weight:500}
    .sidebar-footer{padding:var(--md);border-top:1px solid var(--border)}

    .sidebar-scrim{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:110;opacity:0;visibility:hidden;transition:all 200ms}
    .sidebar-scrim.active{opacity:1;visibility:visible}

    .main{flex:1;margin-left:var(--sidebar-w)}
    [dir="rtl"] .main{margin-left:0;margin-right:var(--sidebar-w)}

    .main-header{background:var(--bg);border-bottom:1px solid var(--border);padding:var(--md) var(--xl);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;gap:var(--md)}
    .main-header h1{font-size:var(--text-xl);font-weight:600}

    .header-left{display:flex;align-items:center;gap:var(--md);min-width:0}
    .header-actions{display:flex;align-items:center;gap:var(--sm);flex-wrap:wrap}

    .menu-btn{display:none;align-items:center;justify-content:center;width:40px;height:40px;border-radius:var(--radius-md);border:1px solid var(--border);background:var(--bg);cursor:pointer}
    .menu-btn:hover{background:var(--bg-subtle);border-color:var(--primary);color:var(--primary)}

    .main-body{padding:var(--xl)}

    @media(max-width:900px){
      .main-header{padding:var(--md) var(--lg)}
      .main-body{padding:var(--lg)}
    }
    @media(max-width:768px){
      .menu-btn{display:inline-flex}
      .sidebar{transform:translateX(-105%)}
      [dir="rtl"] .sidebar{transform:translateX(105%)}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0}
      [dir="rtl"] .main{margin-right:0}
    }

    .card{background:var(--bg);border-radius:var(--radius-lg);box-shadow:var(--shadow);border:1px solid var(--border)}
    .card-header{padding:var(--md) var(--lg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:var(--md)}
    .card-title{font-size:var(--text-lg);font-weight:600}
    .card-body{padding:var(--lg)}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sm);padding:var(--sm) var(--md);border:none;border-radius:var(--radius-md);font-size:var(--text-sm);font-weight:500;cursor:pointer;transition:all 150ms;text-decoration:none;white-space:nowrap}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--primary-dark)}
    .btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
    .btn-secondary:hover:not(:disabled){background:var(--bg-subtle)}
    .btn-success{background:var(--success);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-danger{background:var(--error);color:#fff}
    .btn-sm{padding:var(--xs) var(--sm);font-size:var(--text-xs)}

    .form-group{margin-bottom:var(--md)}
    .form-label{display:block;font-size:var(--text-sm);font-weight:500;margin-bottom:var(--xs)}
    .form-input,.form-select,.form-textarea{width:100%;padding:var(--sm);border:1px solid var(--border);border-radius:var(--radius-md);font-size:var(--text-sm);font-family:inherit}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-bg)}
    .form-textarea{min-height:80px;resize:vertical}

    .badge{display:inline-flex;align-items:center;padding:var(--xs) var(--sm);font-size:var(--text-xs);font-weight:500;border-radius:var(--radius-sm);text-transform:uppercase}
    .badge-pending{background:var(--warning-bg);color:var(--warning)}
    .badge-confirmed{background:var(--success-bg);color:var(--success)}
    .badge-completed{background:#e0e7ff;color:#3730a3}
    .badge-canceled{background:var(--error-bg);color:var(--error)}
    .badge-info{background:var(--info-bg);color:var(--info)}
    .badge-alt{background:#fef3c7;color:#92400e}

    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:var(--sm) var(--md);text-align:left;border-bottom:1px solid var(--border);vertical-align:top}
    [dir="rtl"] th,[dir="rtl"] td{text-align:right}
    th{font-size:var(--text-xs);font-weight:600;color:var(--text-muted);text-transform:uppercase;background:var(--bg-subtle)}
    tr:hover td{background:var(--bg-subtle)}
    .clickable{cursor:pointer}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--lg);margin-bottom:var(--xl)}
    .stat-card{background:var(--bg);border-radius:var(--radius-lg);padding:var(--lg);border:1px solid var(--border)}
    .stat-label{font-size:var(--text-sm);color:var(--text-muted);margin-bottom:var(--xs)}
    .stat-value{font-size:var(--text-xl);font-weight:700;color:var(--text)}
    .stat-icon{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin-bottom:var(--sm)}
    .stat-icon.pending{background:var(--warning-bg);color:var(--warning)}
    .stat-icon.confirmed{background:var(--success-bg);color:var(--success)}
    .stat-icon.total{background:var(--primary-bg);color:var(--primary)}
    .stat-icon.alt{background:#fef3c7;color:#92400e}

    .filters{display:flex;flex-wrap:wrap;gap:var(--md);margin-bottom:var(--lg);padding:var(--md);background:var(--bg-subtle);border-radius:var(--radius-md)}
    .filter-group{display:flex;flex-direction:column;gap:var(--xs)}
    .filter-group label{font-size:var(--text-xs);color:var(--text-muted);font-weight:500}
    .filter-group select,.filter-group input{padding:var(--xs) var(--sm);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:var(--text-sm);min-width:140px}

    .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;opacity:0;visibility:hidden;transition:all 200ms}
    .drawer-overlay.active{opacity:1;visibility:visible}
    .drawer{position:fixed;top:0;right:0;width:100%;max-width:600px;height:100%;background:var(--bg);box-shadow:-4px 0 20px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 200ms;z-index:201;display:flex;flex-direction:column}
    [dir="rtl"] .drawer{right:auto;left:0;transform:translateX(-100%)}
    .drawer-overlay.active .drawer{transform:translateX(0)}
    .drawer-header{padding:var(--lg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:var(--md)}
    .drawer-title{font-size:var(--text-lg);font-weight:600}
    .drawer-close{width:32px;height:32px;border:none;background:transparent;cursor:pointer;color:var(--text-muted);display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm)}
    .drawer-close:hover{background:var(--bg-subtle);color:var(--text)}
    .drawer-body{flex:1;overflow-y:auto;padding:var(--lg)}
    .drawer-footer{padding:var(--lg);border-top:1px solid var(--border);display:flex;gap:var(--sm);flex-wrap:wrap;justify-content:flex-end}

    .avail-grid{display:grid;grid-template-columns:80px repeat(6,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
    .avail-cell{background:var(--bg);padding:var(--sm);text-align:center;font-size:var(--text-sm)}
    .avail-header{background:var(--bg-subtle);font-weight:600;font-size:var(--text-xs);color:var(--text-muted)}
    .avail-time{background:var(--bg-subtle);font-weight:500;font-size:var(--text-xs)}
    .avail-slot{cursor:pointer;transition:all 150ms;user-select:none}
    .avail-slot:hover{background:var(--primary-bg)}
    .avail-slot.available{background:#dcfce7;color:var(--success)}
    .avail-slot.unavailable{background:var(--bg-subtle);color:var(--text-light)}
    .avail-slot.pending{background:var(--warning-bg);color:var(--warning)}
    .avail-slot.confirmed{background:var(--error-bg);color:var(--error)}
    .avail-slot.disabled{opacity:0.55;cursor:not-allowed}

    .detail-section{margin-bottom:var(--lg);padding-bottom:var(--lg);border-bottom:1px solid var(--border)}
    .detail-section:last-child{border-bottom:none}
    .detail-title{font-size:var(--text-sm);font-weight:600;color:var(--text);margin-bottom:var(--md);text-transform:uppercase}
    .detail-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--md)}
    @media(min-width:480px){.detail-grid{grid-template-columns:repeat(3,1fr)}}
    .detail-label{font-size:var(--text-xs);color:var(--text-muted)}
    .detail-value{font-size:var(--text-sm);color:var(--text);font-weight:500}

    .timeline{position:relative;padding-left:var(--lg)}
    [dir="rtl"] .timeline{padding-left:0;padding-right:var(--lg)}
    .timeline::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;background:var(--border)}
    [dir="rtl"] .timeline::before{left:auto;right:6px}
    .timeline-item{position:relative;padding-bottom:var(--md)}
    .timeline-dot{position:absolute;left:calc(-1* var(--lg) + 2px);width:10px;height:10px;background:var(--border);border-radius:50%;border:2px solid var(--bg)}
    [dir="rtl"] .timeline-dot{left:auto;right:calc(-1* var(--lg) + 2px)}
    .timeline-dot.active{background:var(--primary)}
    .timeline-date{font-size:var(--text-xs);color:var(--text-muted)}
    .timeline-text{font-size:var(--text-sm);color:var(--text)}

    .actions-panel{background:var(--bg-subtle);border-radius:var(--radius-md);padding:var(--md);margin-bottom:var(--lg);border:1px solid var(--border)}
    .actions-title{font-size:var(--text-sm);font-weight:600;margin-bottom:var(--md)}
    .actions-btns{display:flex;flex-wrap:wrap;gap:var(--sm)}
    .alt-picker{margin-top:var(--md);padding:var(--md);background:#fff7ed;border-radius:var(--radius-md);border:1px solid #fed7aa}
    .alt-picker-title{font-size:var(--text-sm);font-weight:600;color:#9a3412;margin-bottom:var(--sm);display:flex;align-items:center;gap:var(--sm)}
    .alt-slots{display:flex;flex-wrap:wrap;gap:var(--sm)}
    .alt-slot{padding:var(--xs) var(--sm);border:2px solid var(--border);border-radius:var(--radius-sm);background:var(--bg);cursor:pointer;font-size:var(--text-xs);line-height:1.2}
    .alt-slot:hover{border-color:var(--primary)}
    .alt-slot.selected{border-color:var(--primary);background:var(--primary-bg)}
    .msg-input{margin-top:var(--md)}

    .attachments{display:flex;flex-wrap:wrap;gap:var(--sm)}
    .attachment-pill{display:inline-flex;align-items:center;gap:var(--xs);padding:var(--xs) var(--sm);border-radius:999px;border:1px solid var(--border);background:var(--bg);font-size:var(--text-xs);color:var(--text-muted)}
    .attachment-pill svg{opacity:0.8}

    .toast{position:fixed;bottom:16px;left:16px;right:16px;max-width:520px;margin:0 auto;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:0 10px 25px rgba(0,0,0,0.12);padding:var(--md);display:flex;align-items:flex-start;gap:var(--md);z-index:999;opacity:0;transform:translateY(8px);pointer-events:none;transition:all 200ms}
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}
    .toast-title{font-weight:700;font-size:var(--text-sm);margin-bottom:2px}
    .toast-msg{font-size:var(--text-sm);color:var(--text-muted)}
    .toast-icon{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center}
    .toast-icon.ok{background:var(--success-bg);color:var(--success)}
    .toast-icon.warn{background:var(--warning-bg);color:var(--warning)}
    .toast-icon.info{background:var(--info-bg);color:var(--info)}
    .toast-actions{margin-left:auto;display:flex;gap:var(--sm)}
    [dir="rtl"] .toast-actions{margin-left:0;margin-right:auto}

    .empty{text-align:center;padding:var(--xl);color:var(--text-muted)}
    .empty-icon{width:64px;height:64px;margin:0 auto var(--md);opacity:0.5}
    .mt-md{margin-top:var(--md)}
    .mb-md{margin-bottom:var(--md)}
    .text-success{color:var(--success)}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:var(--md)}
  </style>
</head>

<body>
  <div class="app">
    <div class="sidebar-scrim" id="sidebar-scrim" onclick="closeSidebar()"></div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="#" class="sidebar-logo" onclick="return false;">Rahvana</a>
        <div class="sidebar-sub">Admin Portal</div>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item active" data-view="requests" onclick="showView('requests')">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2"></rect>
            <path d="M16 2v4M8 2v4M3 10h18"></path>
          </svg>
          Requests
        </button>

        <button class="nav-item" data-view="availability" onclick="showView('availability')">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          Availability
        </button>

        <button class="nav-item" data-view="settings" onclick="showView('settings')">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
          </svg>
          Settings
        </button>
      </nav>

      <div class="sidebar-footer">
        <button class="btn btn-secondary btn-sm" style="width:100%" onclick="toggleDirection()">
          <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12H3M21 12L15 6M21 12L15 18M3 12L9 6M3 12L9 18"></path>
          </svg>
          <span id="dir-label">LTR</span>
        </button>
      </div>
    </aside>

    <main class="main">
      <!-- Requests View -->
      <div id="requests-view">
        <header class="main-header">
          <div class="header-left">
            <button class="menu-btn" aria-label="Open menu" onclick="openSidebar()">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <h1 style="min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Consultation Requests</h1>
          </div>

          <div class="header-actions">
            <button class="btn btn-secondary btn-sm" onclick="loadRequests()">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
              </svg>
              Refresh
            </button>
          </div>
        </header>

        <div class="main-body">
          <div class="stats">
            <div class="stat-card">
              <div class="stat-icon pending">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path>
                </svg>
              </div>
              <div class="stat-label">Pending Approval</div>
              <div class="stat-value" id="stat-pending">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon alt">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle><path d="M12 8v4M12 16h.01"></path>
                </svg>
              </div>
              <div class="stat-label">Alternatives Proposed</div>
              <div class="stat-value" id="stat-alt">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon confirmed">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle>
                </svg>
              </div>
              <div class="stat-label">Confirmed</div>
              <div class="stat-value" id="stat-confirmed">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon total">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                </svg>
              </div>
              <div class="stat-label">Total Requests</div>
              <div class="stat-value" id="stat-total">0</div>
            </div>
          </div>

          <div class="filters" aria-label="Filters">
            <div class="filter-group">
              <label>Status</label>
              <select id="filter-status" onchange="loadRequests()">
                <option value="">All</option>
                <option value="pending_approval">Pending</option>
                <option value="alternatives_proposed">Alternatives</option>
                <option value="needs_more_info">More Info</option>
                <option value="confirmed">Confirmed</option>
                <option value="completed">Completed</option>
                <option value="canceled">Canceled</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Urgency</label>
              <select id="filter-urgency" onchange="loadRequests()">
                <option value="">All</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Visa</label>
              <select id="filter-visa" onchange="loadRequests()">
                <option value="">All</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Issue</label>
              <select id="filter-issue" onchange="loadRequests()">
                <option value="">All</option>
              </select>
            </div>

            <div class="filter-group" style="flex:1;min-width:200px">
              <label>Search</label>
              <input type="text" id="filter-search" placeholder="Name, ID, email..." oninput="loadRequests()" />
            </div>
          </div>

          <div class="card">
            <div class="table-wrap">
              <table aria-label="Requests table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Visa</th>
                    <th>Issue</th>
                    <th>Urgency</th>
                    <th>Slot</th>
                    <th>Status</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="requests-tbody"></tbody>
              </table>
            </div>

            <div class="empty hidden" id="empty-requests">
              <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect><path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
              <p style="font-weight:600;color:var(--text)">No requests found</p>
              <p>Requests from the booking page will appear here.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Availability View -->
      <div id="availability-view" class="hidden">
        <header class="main-header">
          <div class="header-left">
            <button class="menu-btn" aria-label="Open menu" onclick="openSidebar()">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <h1>Availability Management</h1>
          </div>

          <div class="header-actions">
            <button class="btn btn-secondary btn-sm" onclick="prevAvailWeek()">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"></path>
              </svg>
            </button>

            <span id="avail-week-label" style="padding:var(--sm);font-weight:500">Week</span>

            <button class="btn btn-secondary btn-sm" onclick="nextAvailWeek()">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"></path>
              </svg>
            </button>
          </div>
        </header>

        <div class="main-body">
          <div class="card">
            <div class="card-header">
              <span class="card-title">Weekly Schedule</span>
              <div style="display:flex;gap:var(--md);font-size:var(--text-xs);flex-wrap:wrap">
                <span><span style="display:inline-block;width:12px;height:12px;background:#dcfce7;border-radius:2px;margin-right:4px"></span>Available</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:var(--bg-subtle);border:1px solid var(--border);border-radius:2px;margin-right:4px"></span>Unavailable</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:var(--warning-bg);border-radius:2px;margin-right:4px"></span>Pending</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:var(--error-bg);border-radius:2px;margin-right:4px"></span>Confirmed</span>
              </div>
            </div>
            <div class="card-body">
              <div class="avail-grid" id="avail-grid"></div>
              <p class="mt-md" style="font-size:var(--text-sm);color:var(--text-muted)">
                Click available/unavailable slots to toggle. Pending/confirmed cannot be changed.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div id="settings-view" class="hidden">
        <header class="main-header">
          <div class="header-left">
            <button class="menu-btn" aria-label="Open menu" onclick="openSidebar()">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <h1>Settings</h1>
          </div>
        </header>

        <div class="main-body">
          <div class="card">
            <div class="card-header"><span class="card-title">Data Management</span></div>
            <div class="card-body">
              <p class="mb-md" style="color:var(--text-muted)">
                Data is stored in browser localStorage and shared with the booking page.
              </p>

              <div style="display:flex;gap:var(--md);flex-wrap:wrap">
                <button class="btn btn-secondary" onclick="exportData()">
                  <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                    <path d="M7 10l5 5 5-5"></path>
                    <path d="M12 15V3"></path>
                  </svg>
                  Export
                </button>

                <button class="btn btn-danger" onclick="clearAllData()">
                  <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path>
                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                  </svg>
                  Clear All
                </button>
              </div>

              <div class="mt-md" style="padding:var(--md);border-radius:var(--radius-md);border:1px dashed var(--border);background:var(--bg-subtle)">
                <div style="font-weight:600;margin-bottom:6px">Tip</div>
                <div style="font-size:var(--text-sm);color:var(--text-muted)">
                  Open the booking page and submit a request. Then return to Requests to manage it.
                </div>
              </div>
            </div>
          </div>

          <div class="card mt-md">
            <div class="card-header"><span class="card-title">Status Definitions</span></div>
            <div class="card-body" style="color:var(--text-muted);font-size:var(--text-sm)">
              <ul style="padding-left:18px;display:grid;gap:8px">
                <li><strong>Pending Approval</strong>: User selected a slot; awaiting admin decision.</li>
                <li><strong>Needs More Info</strong>: Admin requested clarification; user should respond out-of-band.</li>
                <li><strong>Alternatives Proposed</strong>: Admin proposed 1–3 slots; user must confirm one.</li>
                <li><strong>Confirmed</strong>: Appointment time is confirmed and slot is locked.</li>
                <li><strong>Completed</strong>: Consultation finished.</li>
                <li><strong>Canceled</strong>: Appointment canceled (slot released if applicable).</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="drawer-overlay" id="drawer-overlay" onclick="drawerOverlayClick(event)">
    <div class="drawer" role="dialog" aria-modal="true" aria-label="Request details drawer">
      <div class="drawer-header">
        <span class="drawer-title" id="drawer-title">Details</span>
        <button class="drawer-close" onclick="closeDrawer()" aria-label="Close drawer">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="drawer-body" id="drawer-body"></div>

      <div class="drawer-footer" id="drawer-footer">
        <button class="btn btn-secondary" onclick="closeDrawer()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="toast-icon info" id="toast-icon">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path>
      </svg>
    </div>
    <div style="min-width:0">
      <div class="toast-title" id="toast-title">Saved</div>
      <div class="toast-msg" id="toast-msg">Your changes were saved.</div>
    </div>
    <div class="toast-actions">
      <button class="btn btn-secondary btn-sm" onclick="hideToast()">OK</button>
    </div>
  </div>

  <script>
    // Shared storage keys (must match booking page)
    const STORAGE_KEY = 'rahvana_consultation_requests';
    const AVAILABILITY_KEY = 'rahvana_availability';

    // Admin UI state
    let currentView = 'requests';
    let drawerRequestId = null;
    let availWeekStart = getMonday(new Date());
    const TIMES = ['09:00','10:00','11:00','14:00','15:00','16:00'];

    // For proposing alternatives (drawer selection)
    let proposedAltSelections = []; // array of {date,time}

    document.addEventListener('DOMContentLoaded', () => {
      ensureAvailabilitySeeded();
      hydrateFilterOptions();
      loadRequests();
      renderAvailabilityGrid();

      // Close drawer with ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('drawer-overlay').classList.contains('active')) closeDrawer();
          if (document.getElementById('sidebar').classList.contains('open')) closeSidebar();
        }
      });
    });

    /* -----------------------------
       Sidebar (mobile)
    ------------------------------*/
    function openSidebar() {
      const s = document.getElementById('sidebar');
      const scrim = document.getElementById('sidebar-scrim');
      s.classList.add('open');
      scrim.classList.add('active');
    }
    function closeSidebar() {
      const s = document.getElementById('sidebar');
      const scrim = document.getElementById('sidebar-scrim');
      s.classList.remove('open');
      scrim.classList.remove('active');
    }

    /* -----------------------------
       Direction toggle
    ------------------------------*/
    function toggleDirection() {
      const html = document.documentElement;
      const label = document.getElementById('dir-label');
      if (html.dir === 'rtl') {
        html.dir = 'ltr';
        label.textContent = 'LTR';
      } else {
        html.dir = 'rtl';
        label.textContent = 'RTL';
      }
    }

    /* -----------------------------
       View navigation
    ------------------------------*/
    function showView(view) {
      currentView = view;

      document.getElementById('requests-view').classList.toggle('hidden', view !== 'requests');
      document.getElementById('availability-view').classList.toggle('hidden', view !== 'availability');
      document.getElementById('settings-view').classList.toggle('hidden', view !== 'settings');

      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });

      if (view === 'requests') loadRequests();
      if (view === 'availability') renderAvailabilityGrid();

      closeSidebar();
    }

    /* -----------------------------
       LocalStorage helpers
    ------------------------------*/
    function getRequests() {
      const raw = localStorage.getItem(STORAGE_KEY);
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function setRequests(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function getAvailability() {
      const raw = localStorage.getItem(AVAILABILITY_KEY);
      try { return raw ? JSON.parse(raw) : {}; } catch { return {}; }
    }
    function setAvailability(obj) {
      localStorage.setItem(AVAILABILITY_KEY, JSON.stringify(obj));
    }
    function updateSlotStatus(dateStr, time, status) {
      const availability = getAvailability();
      if (!availability[dateStr]) availability[dateStr] = {};
      availability[dateStr][time] = status;
      setAvailability(availability);
    }

    // Booking page seeds, but admin should be safe if opened first.
    function ensureAvailabilitySeeded() {
      const existing = localStorage.getItem(AVAILABILITY_KEY);
      if (existing) return;

      const slots = {};
      const today = new Date();
      for (let i = 0; i < 14; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const dow = d.getDay();
        if (dow === 0) continue; // skip Sunday
        const key = formatDateKey(d);
        slots[key] = {};
        TIMES.forEach(t => {
          // Light randomness, mostly available
          slots[key][t] = Math.random() > 0.18 ? 'available' : 'unavailable';
        });
      }
      setAvailability(slots);
    }

    /* -----------------------------
       Requests list + filters + stats
    ------------------------------*/
    function hydrateFilterOptions() {
      const requests = getRequests();
      const visaSel = document.getElementById('filter-visa');
      const issueSel = document.getElementById('filter-issue');

      const visaSet = new Map();
      const issueSet = new Map();

      requests.forEach(r => {
        if (r.visaCategory) visaSet.set(r.visaCategory, r.visaCategoryLabel || r.visaCategory);
        if (r.issueCategory) issueSet.set(r.issueCategory, r.issueCategoryLabel || r.issueCategory);
      });

      const currentVisa = visaSel.value;
      const currentIssue = issueSel.value;

      visaSel.innerHTML = '<option value="">All</option>' + Array.from(visaSet.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .map(([val,label]) => `<option value="${escapeAttr(val)}">${escapeHtml(label)}</option>`)
        .join('');

      issueSel.innerHTML = '<option value="">All</option>' + Array.from(issueSet.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .map(([val,label]) => `<option value="${escapeAttr(val)}">${escapeHtml(label)}</option>`)
        .join('');

      visaSel.value = currentVisa;
      issueSel.value = currentIssue;
    }

    function loadRequests() {
      const tbody = document.getElementById('requests-tbody');
      const empty = document.getElementById('empty-requests');

      let requests = getRequests();

      // Update filter options (new categories may appear)
      hydrateFilterOptions();

      // Stats
      const total = requests.length;
      const pending = requests.filter(r => r.status === 'pending_approval').length;
      const confirmed = requests.filter(r => r.status === 'confirmed').length;
      const alt = requests.filter(r => r.status === 'alternatives_proposed').length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-confirmed').textContent = confirmed;
      document.getElementById('stat-alt').textContent = alt;

      // Filters
      const fStatus = document.getElementById('filter-status').value.trim();
      const fUrg = document.getElementById('filter-urgency').value.trim();
      const fVisa = document.getElementById('filter-visa').value.trim();
      const fIssue = document.getElementById('filter-issue').value.trim();
      const q = document.getElementById('filter-search').value.trim().toLowerCase();

      requests = requests.filter(r => {
        if (fStatus && r.status !== fStatus) return false;
        if (fUrg && (r.urgency || '').toLowerCase() !== fUrg) return false;
        if (fVisa && r.visaCategory !== fVisa) return false;
        if (fIssue && r.issueCategory !== fIssue) return false;

        if (q) {
          const hay = [
            r.id, r.fullName, r.email, r.whatsapp,
            r.visaCategoryLabel, r.issueCategoryLabel
          ].filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      // Sort newest first
      requests.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

      if (requests.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');

      tbody.innerHTML = requests.map(r => {
        const slot = r.confirmedSlot ? r.confirmedSlot : r.requestedSlot;
        const slotLabel = slot ? formatSlotShort(slot) : 'N/A';

        return `
          <tr class="clickable" onclick="openDrawer('${escapeAttr(r.id)}')">
            <td><span style="font-family:monospace;font-size:var(--text-sm);color:var(--text-muted)">${escapeHtml(r.id)}</span></td>
            <td>${escapeHtml(r.fullName || '—')}</td>
            <td>${escapeHtml(r.visaCategoryLabel || '—')}</td>
            <td>${escapeHtml(truncate(r.issueCategoryLabel || '—', 28))}</td>
            <td>${escapeHtml((r.urgencyLabel || r.urgency || '—'))}</td>
            <td>${escapeHtml(slotLabel)}</td>
            <td>${statusBadge(r.status)}</td>
            <td>${escapeHtml(formatDateTimeShort(r.createdAt))}</td>
          </tr>
        `;
      }).join('');
    }

    function statusBadge(status) {
      const map = {
        pending_approval: '<span class="badge badge-pending">Pending</span>',
        needs_more_info: '<span class="badge badge-info">More Info</span>',
        alternatives_proposed: '<span class="badge badge-alt">Alternatives</span>',
        confirmed: '<span class="badge badge-confirmed">Confirmed</span>',
        completed: '<span class="badge badge-completed">Completed</span>',
        canceled: '<span class="badge badge-canceled">Canceled</span>'
      };
      return map[status] || '<span class="badge badge-pending">Unknown</span>';
    }

    /* -----------------------------
       Drawer: open/render
    ------------------------------*/
    function openDrawer(requestId) {
      const requests = getRequests();
      const req = requests.find(r => r.id === requestId);
      if (!req) return;

      drawerRequestId = requestId;
      proposedAltSelections = []; // reset

      document.getElementById('drawer-title').textContent = `Request ${req.id}`;
      document.getElementById('drawer-body').innerHTML = renderRequestDetail(req);
      document.getElementById('drawer-footer').innerHTML = renderDrawerFooter(req);

      document.getElementById('drawer-overlay').classList.add('active');
      lockBodyScroll(true);

      // Ensure focus for accessibility
      setTimeout(() => {
        const closeBtn = document.querySelector('.drawer-close');
        if (closeBtn) closeBtn.focus();
      }, 0);
    }

    function closeDrawer() {
      drawerRequestId = null;
      proposedAltSelections = [];
      document.getElementById('drawer-overlay').classList.remove('active');
      lockBodyScroll(false);
    }

    function drawerOverlayClick(e) {
      if (e.target.id === 'drawer-overlay') closeDrawer();
    }

    function renderDrawerFooter(req) {
      // Keep footer simple; actions live in drawer content.
      return `
        <button class="btn btn-secondary" onclick="closeDrawer()">Close</button>
      `;
    }

    function renderRequestDetail(req) {
      const created = formatDateTimeLong(req.createdAt);
      const updated = req.updatedAt ? formatDateTimeLong(req.updatedAt) : created;

      const requested = req.requestedSlot ? formatSlotLong(req.requestedSlot) : 'N/A';
      const confirmed = req.confirmedSlot ? formatSlotLong(req.confirmedSlot) : null;

      const attachmentsHtml = (req.attachments && req.attachments.length)
        ? `<div class="attachments">
             ${req.attachments.map(a => `
               <span class="attachment-pill">
                 <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                   <path d="M14 2v6h6"></path>
                 </svg>
                 ${escapeHtml(a)}
               </span>
             `).join('')}
           </div>`
        : `<div style="color:var(--text-light);font-size:var(--text-sm)">No attachments</div>`;

      const messagesHtml = (req.messages && req.messages.length)
        ? req.messages.map(m => `
            <div style="padding:var(--md);border-radius:var(--radius-md);border:1px solid var(--border);background:var(--bg);margin-bottom:var(--sm)">
              <div style="display:flex;justify-content:space-between;gap:var(--md);margin-bottom:4px">
                <div style="font-weight:700;font-size:var(--text-sm);color:var(--info)">Admin message</div>
                <div style="font-size:var(--text-xs);color:var(--text-muted)">${escapeHtml(formatDateTimeShort(m.date))}</div>
              </div>
              <div style="font-size:var(--text-sm);color:var(--text)">${escapeHtml(m.text)}</div>
            </div>
          `).join('')
        : `<div style="color:var(--text-light);font-size:var(--text-sm)">No messages sent yet</div>`;

      const timelineHtml = (req.timeline && req.timeline.length)
        ? `
          <div class="timeline">
            ${req.timeline.map((t, idx) => `
              <div class="timeline-item">
                <div class="timeline-dot ${idx === 0 ? 'active' : ''}"></div>
                <div>
                  <div class="timeline-date">${escapeHtml(formatDateTimeShort(t.date))}</div>
                  <div class="timeline-text">${escapeHtml(t.action || 'Update')}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `
        : `<div style="color:var(--text-light);font-size:var(--text-sm)">No timeline events</div>`;

      const altSection = renderAltSection(req);

      return `
        <div class="flex-between mb-md">
          <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
            <div style="display:flex;align-items:center;gap:var(--sm);flex-wrap:wrap">
              <span style="font-family:monospace;color:var(--text-muted)">${escapeHtml(req.id)}</span>
              ${statusBadge(req.status)}
            </div>
            <div style="font-size:var(--text-xs);color:var(--text-muted)">
              Created: ${escapeHtml(created)} · Updated: ${escapeHtml(updated)}
            </div>
          </div>
          <div style="display:flex;gap:var(--sm);flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-secondary btn-sm" onclick="copyRequestSummary('${escapeAttr(req.id)}')">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
              </svg>
              Copy Summary
            </button>
          </div>
        </div>

        <div class="actions-panel">
          <div class="actions-title">Actions</div>
          <div class="actions-btns">
            <button class="btn btn-success" onclick="approveRequestedSlot('${escapeAttr(req.id)}')" ${req.status !== 'pending_approval' ? 'disabled' : ''}>
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle>
              </svg>
              Approve Requested Slot
            </button>

            <button class="btn btn-warning" onclick="toggleAltPicker()" ${req.status === 'canceled' || req.status === 'completed' ? 'disabled' : ''}>
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle><path d="M12 8v4M12 16h.01"></path>
              </svg>
              Propose Alternatives
            </button>

            <button class="btn btn-secondary" onclick="toggleMessagePanel()" ${req.status === 'canceled' || req.status === 'completed' ? 'disabled' : ''}>
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4z"></path>
              </svg>
              Request More Info
            </button>

            <button class="btn btn-secondary" onclick="markStatus('${escapeAttr(req.id)}','completed')" ${req.status !== 'confirmed' ? 'disabled' : ''}>
              Mark Completed
            </button>

            <button class="btn btn-danger" onclick="cancelRequest('${escapeAttr(req.id)}')" ${req.status === 'canceled' || req.status === 'completed' ? 'disabled' : ''}>
              Cancel
            </button>
          </div>

          ${altSection}
          ${renderMessagePanel(req)}
        </div>

        <div class="detail-section">
          <div class="detail-title">Case Information</div>
          <div class="detail-grid">
            <div>
              <div class="detail-label">Issue</div>
              <div class="detail-value">${escapeHtml(req.issueCategoryLabel || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Visa Category</div>
              <div class="detail-value">${escapeHtml(req.visaCategoryLabel || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Case Stage</div>
              <div class="detail-value">${escapeHtml(req.caseStageLabel || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Embassy</div>
              <div class="detail-value">${escapeHtml(req.embassyLabel || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Urgency</div>
              <div class="detail-value">${escapeHtml(req.urgencyLabel || req.urgency || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Preferred Language</div>
              <div class="detail-value">${escapeHtml(req.language || '—')}</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-title">Appointment</div>
          <div class="detail-grid">
            <div>
              <div class="detail-label">Requested Slot</div>
              <div class="detail-value">${escapeHtml(requested)}</div>
            </div>
            <div>
              <div class="detail-label">Confirmed Slot</div>
              <div class="detail-value ${confirmed ? 'text-success' : ''}">${escapeHtml(confirmed || '—')}</div>
            </div>
          </div>
          ${req.alternativeSlots && req.alternativeSlots.length ? `
            <div class="mt-md" style="font-size:var(--text-sm);color:var(--text-muted)">
              Proposed alternatives:
            </div>
            <div class="alt-slots mt-md" aria-label="Proposed alternative slots">
              ${req.alternativeSlots.map(s => `
                <span class="alt-slot" style="cursor:default">
                  ${escapeHtml(formatSlotShort(s))}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>

        <div class="detail-section">
          <div class="detail-title">Contact</div>
          <div class="detail-grid">
            <div>
              <div class="detail-label">Name</div>
              <div class="detail-value">${escapeHtml(req.fullName || '—')}</div>
            </div>
            <div>
              <div class="detail-label">Email</div>
              <div class="detail-value">${escapeHtml(req.email || '—')}</div>
            </div>
            <div>
              <div class="detail-label">WhatsApp</div>
              <div class="detail-value">${escapeHtml(req.whatsapp || '—')}</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-title">Case Summary</div>
          <div style="font-size:var(--text-sm);color:var(--text);white-space:pre-wrap">${escapeHtml(req.caseSummary || '')}</div>
        </div>

        <div class="detail-section">
          <div class="detail-title">Attachments</div>
          ${attachmentsHtml}
        </div>

        <div class="detail-section">
          <div class="detail-title">Messages</div>
          ${messagesHtml}
        </div>

        <div class="detail-section">
          <div class="detail-title">Timeline</div>
          ${timelineHtml}
        </div>
      `;
    }

    function renderAltSection(req) {
      // Hidden by default; toggled via Propose Alternatives button.
      // Admin selects up to 3 available slots from the next 14 days.
      const availability = getAvailability();
      const slots = listCandidateSlots(availability);

      // Pre-select existing alternatives if any
      const existing = (req.alternativeSlots || []).map(s => `${s.date}|${s.time}`);
      proposedAltSelections = existing.map(k => {
        const [date,time] = k.split('|');
        return {date,time};
      });

      const chips = slots.map(s => {
        const key = `${s.date}|${s.time}`;
        const selected = existing.includes(key);
        return `
          <button
            type="button"
            class="alt-slot ${selected ? 'selected' : ''}"
            onclick="toggleProposedAlt('${escapeAttr(s.date)}','${escapeAttr(s.time)}', this)"
            aria-pressed="${selected ? 'true' : 'false'}"
          >
            ${escapeHtml(formatSlotShort(s))}
          </button>
        `;
      }).join('');

      return `
        <div class="alt-picker hidden" id="alt-picker">
          <div class="alt-picker-title">
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle><path d="M12 8v4M12 16h.01"></path>
            </svg>
            Select up to 3 alternative slots
          </div>

          <div style="font-size:var(--text-sm);color:var(--text-muted);margin-bottom:var(--sm)">
            Only slots marked <span style="color:var(--success);font-weight:700">available</span> are selectable.
          </div>

          <div class="alt-slots" id="alt-slot-chips">
            ${chips || `<div style="color:var(--text-light);font-size:var(--text-sm)">No available slots found in the next 14 days.</div>`}
          </div>

          <div class="msg-input">
            <label class="form-label">Optional note to user</label>
            <textarea class="form-textarea" id="alt-note" placeholder="Short explanation (optional)"></textarea>
          </div>

          <div style="display:flex;gap:var(--sm);flex-wrap:wrap;margin-top:var(--md)">
            <button class="btn btn-primary" onclick="submitAlternatives('${escapeAttr(req.id)}')" ${req.status === 'canceled' || req.status === 'completed' ? 'disabled' : ''}>
              Propose Selected Slots
            </button>
            <button class="btn btn-secondary" onclick="toggleAltPicker()">Cancel</button>
          </div>
        </div>
      `;
    }

    function renderMessagePanel(req) {
      // Hidden by default; toggled via Request More Info button.
      return `
        <div class="msg-input hidden" id="msg-panel" style="margin-top:var(--md)">
          <label class="form-label">Message to user</label>
          <textarea class="form-textarea" id="admin-message" placeholder="Ask for missing details or clarification..."></textarea>
          <div style="display:flex;gap:var(--sm);flex-wrap:wrap;margin-top:var(--md)">
            <button class="btn btn-primary" onclick="sendMoreInfoMessage('${escapeAttr(req.id)}')" ${req.status === 'canceled' || req.status === 'completed' ? 'disabled' : ''}>
              Send Message
            </button>
            <button class="btn btn-secondary" onclick="toggleMessagePanel()">Cancel</button>
          </div>
        </div>
      `;
    }

    function toggleAltPicker() {
      const el = document.getElementById('alt-picker');
      if (!el) return;
      el.classList.toggle('hidden');
      // close message panel if open
      const msg = document.getElementById('msg-panel');
      if (msg && !msg.classList.contains('hidden')) msg.classList.add('hidden');
    }

    function toggleMessagePanel() {
      const el = document.getElementById('msg-panel');
      if (!el) return;
      el.classList.toggle('hidden');
      // close alt picker if open
      const alt = document.getElementById('alt-picker');
      if (alt && !alt.classList.contains('hidden')) alt.classList.add('hidden');
    }

    /* -----------------------------
       Admin Actions
    ------------------------------*/
    function approveRequestedSlot(requestId) {
      const requests = getRequests();
      const idx = requests.findIndex(r => r.id === requestId);
      if (idx === -1) return;

      const r = requests[idx];
      if (r.status !== 'pending_approval') {
        showToast('Not allowed', 'Only pending requests can be approved.', 'warn');
        return;
      }
      if (!r.requestedSlot) {
        showToast('Missing slot', 'No requested slot found on this request.', 'warn');
        return;
      }

      // Lock the requested slot
      updateSlotStatus(r.requestedSlot.date, r.requestedSlot.time, 'confirmed');

      r.confirmedSlot = { ...r.requestedSlot };
      r.status = 'confirmed';
      r.updatedAt = new Date().toISOString();
      r.timeline = r.timeline || [];
      r.timeline.unshift({
        date: new Date().toISOString(),
        action: 'Admin approved requested slot',
        status: 'confirmed'
      });

      // Clear any previous alternatives
      r.alternativeSlots = [];
      requests[idx] = r;
      setRequests(requests);

      showToast('Confirmed', 'The requested slot was approved and locked.', 'ok');
      loadRequests();
      renderAvailabilityGrid();
      refreshDrawer();
    }

    function submitAlternatives(requestId) {
      const requests = getRequests();
      const idx = requests.findIndex(r => r.id === requestId);
      if (idx === -1) return;
      const r = requests[idx];

      if (!proposedAltSelections.length) {
        showToast('No slots selected', 'Select 1–3 available alternatives first.', 'warn');
        return;
      }
      if (proposedAltSelections.length > 3) {
        showToast('Too many', 'Select up to 3 alternatives.', 'warn');
        return;
      }

      // Release the originally requested "pending" slot to available (since admin is proposing alternatives)
      // Keep requestedSlot stored for record, but free availability.
      if (r.requestedSlot) {
        const avail = getAvailability();
        const current = (avail[r.requestedSlot.date] && avail[r.requestedSlot.date][r.requestedSlot.time]) || 'unavailable';
        if (current === 'pending') updateSlotStatus(r.requestedSlot.date, r.requestedSlot.time, 'available');
      }

      r.alternativeSlots = proposedAltSelections.map(s => ({date:s.date,time:s.time}));
      r.status = 'alternatives_proposed';
      r.updatedAt = new Date().toISOString();
      r.timeline = r.timeline || [];
      r.timeline.unshift({
        date: new Date().toISOString(),
        action: 'Admin proposed alternative slots',
        status: 'alternatives_proposed'
      });

      // Optional note is stored as a message (so user sees it)
      const note = (document.getElementById('alt-note')?.value || '').trim();
      if (note) {
        r.messages = r.messages || [];
        r.messages.unshift({date:new Date().toISOString(), text: note});
      }

      requests[idx] = r;
      setRequests(requests);

      showToast('Alternatives proposed', 'User will pick one of the suggested times.', 'info');
      loadRequests();
      renderAvailabilityGrid();
      refreshDrawer();
    }

    function sendMoreInfoMessage(requestId) {
      const msgEl = document.getElementById('admin-message');
      const text = (msgEl ? msgEl.value : '').trim();
      if (!text) {
        showToast('Empty message', 'Type a message before sending.', 'warn');
        return;
      }

      const requests = getRequests();
      const idx = requests.findIndex(r => r.id === requestId);
      if (idx === -1) return;

      const r = requests[idx];
      r.messages = r.messages || [];
      r.messages.unshift({date:new Date().toISOString(), text});

      r.status = 'needs_more_info';
      r.updatedAt = new Date().toISOString();
      r.timeline = r.timeline || [];
      r.timeline.unshift({
        date: new Date().toISOString(),
        action: 'Admin requested more information',
        status: 'needs_more_info'
      });

      requests[idx] = r;
      setRequests(requests);

      if (msgEl) msgEl.value = '';
      showToast('Sent', 'Message saved and status set to Needs More Info.', 'info');
      loadRequests();
      refreshDrawer();
    }

    function markStatus(requestId, status) {
      const requests = getRequests();
      const idx = requests.findIndex(r => r.id === requestId);
      if (idx === -1) return;

      const r = requests[idx];
      r.status = status;
      r.updatedAt = new Date().toISOString();
      r.timeline = r.timeline || [];
      r.timeline.unshift({
        date: new Date().toISOString(),
        action: `Admin set status to ${statusLabel(status)}`,
        status
      });

      requests[idx] = r;
      setRequests(requests);

      showToast('Updated', `Status set to ${statusLabel(status)}.`, 'ok');
      loadRequests();
      refreshDrawer();
    }

    function cancelRequest(requestId) {
      const requests = getRequests();
      const idx = requests.findIndex(r => r.id === requestId);
      if (idx === -1) return;

      const r = requests[idx];

      // Release any locked slots (confirmed or pending) if appropriate
      if (r.confirmedSlot) {
        updateSlotStatus(r.confirmedSlot.date, r.confirmedSlot.time, 'available');
        r.confirmedSlot = null;
      } else if (r.requestedSlot) {
        const avail = getAvailability();
        const cur = (avail[r.requestedSlot.date] && avail[r.requestedSlot.date][r.requestedSlot.time]) || 'unavailable';
        if (cur === 'pending') updateSlotStatus(r.requestedSlot.date, r.requestedSlot.time, 'available');
      }

      r.status = 'canceled';
      r.updatedAt = new Date().toISOString();
      r.timeline = r.timeline || [];
      r.timeline.unshift({
        date: new Date().toISOString(),
        action: 'Admin canceled request',
        status: 'canceled'
      });

      requests[idx] = r;
      setRequests(requests);

      showToast('Canceled', 'Request canceled and slot released.', 'warn');
      loadRequests();
      renderAvailabilityGrid();
      refreshDrawer();
    }

    function refreshDrawer() {
      if (!drawerRequestId) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === drawerRequestId);
      if (!req) {
        closeDrawer();
        return;
      }
      document.getElementById('drawer-title').textContent = `Request ${req.id}`;
      document.getElementById('drawer-body').innerHTML = renderRequestDetail(req);
      document.getElementById('drawer-footer').innerHTML = renderDrawerFooter(req);
    }

    function toggleProposedAlt(date, time, btnEl) {
      const key = `${date}|${time}`;
      const idx = proposedAltSelections.findIndex(s => `${s.date}|${s.time}` === key);

      if (idx !== -1) {
        proposedAltSelections.splice(idx, 1);
        btnEl.classList.remove('selected');
        btnEl.setAttribute('aria-pressed', 'false');
        return;
      }

      if (proposedAltSelections.length >= 3) {
        showToast('Limit reached', 'You can select up to 3 alternative slots.', 'warn');
        return;
      }

      proposedAltSelections.push({date, time});
      btnEl.classList.add('selected');
      btnEl.setAttribute('aria-pressed', 'true');
    }

    /* -----------------------------
       Availability view rendering
    ------------------------------*/
    function prevAvailWeek() {
      const newStart = new Date(availWeekStart);
      newStart.setDate(newStart.getDate() - 7);
      availWeekStart = newStart;
      renderAvailabilityGrid();
    }

    function nextAvailWeek() {
      const newStart = new Date(availWeekStart);
      newStart.setDate(newStart.getDate() + 7);
      availWeekStart = newStart;
      renderAvailabilityGrid();
    }

    function renderAvailabilityGrid() {
      const grid = document.getElementById('avail-grid');
      if (!grid) return;

      const start = getMonday(availWeekStart);
      const days = [];
      // Mon-Sat (6 columns) to match CSS grid template
      for (let i = 0; i < 6; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        days.push(d);
      }

      const availability = getAvailability();

      const weekLabel = document.getElementById('avail-week-label');
      const end = new Date(start);
      end.setDate(start.getDate() + 5);

      weekLabel.textContent = `${formatDateShort(start)} - ${formatDateShort(end)} ${start.getFullYear()}`;

      const headerRow = [
        `<div class="avail-cell avail-header">Time</div>`,
        ...days.map(d => `<div class="avail-cell avail-header">${escapeHtml(dayNameShort(d))}<br><span style="font-weight:700;color:var(--text)">${d.getDate()}</span></div>`)
      ].join('');

      const rows = TIMES.map(time => {
        const timeCell = `<div class="avail-cell avail-time">${escapeHtml(formatTime12h(time))}</div>`;
        const dayCells = days.map(d => {
          const key = formatDateKey(d);
          const status = (availability[key] && availability[key][time]) ? availability[key][time] : 'unavailable';

          const isLocked = status === 'pending' || status === 'confirmed';
          const isPast = isBeforeToday(d);

          const cls = ['avail-cell','avail-slot', statusClass(status)];
          if (isLocked || isPast) cls.push('disabled');

          const title = isPast
            ? 'Past date'
            : isLocked
              ? 'Locked by request'
              : 'Click to toggle';

          const onclick = (!isLocked && !isPast)
            ? `onclick="toggleAvailabilitySlot('${escapeAttr(key)}','${escapeAttr(time)}')"`
            : '';

          return `<div class="${cls.join(' ')}" ${onclick} title="${escapeAttr(title)}">${escapeHtml(statusLabelMini(status))}</div>`;
        }).join('');

        return timeCell + dayCells;
      }).join('');

      grid.innerHTML = headerRow + rows;
    }

    function toggleAvailabilitySlot(dateStr, time) {
      const availability = getAvailability();
      if (!availability[dateStr]) availability[dateStr] = {};
      const current = availability[dateStr][time] || 'unavailable';

      // Do not toggle locked states
      if (current === 'pending' || current === 'confirmed') return;

      availability[dateStr][time] = (current === 'available') ? 'unavailable' : 'available';
      setAvailability(availability);

      renderAvailabilityGrid();
      showToast('Updated', `Slot set to ${availability[dateStr][time]}.`, 'ok');
    }

    /* -----------------------------
       Settings actions
    ------------------------------*/
    function exportData() {
      const payload = {
        exportedAt: new Date().toISOString(),
        requests: getRequests(),
        availability: getAvailability()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `rahvana_admin_export_${formatDateKey(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Export ready', 'Downloaded JSON export.', 'info');
    }

    function clearAllData() {
      const ok = confirm('Clear all requests and availability data from this browser?');
      if (!ok) return;

      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AVAILABILITY_KEY);

      ensureAvailabilitySeeded();
      hydrateFilterOptions();
      loadRequests();
      renderAvailabilityGrid();
      closeDrawer();
      showToast('Cleared', 'All local data was removed.', 'warn');
    }

    /* -----------------------------
       Copy summary helper
    ------------------------------*/
    async function copyRequestSummary(requestId) {
      const req = getRequests().find(r => r.id === requestId);
      if (!req) return;

      const summary = [
        `Request: ${req.id}`,
        `Status: ${statusLabel(req.status)}`,
        `Name: ${req.fullName || ''}`,
        `Email: ${req.email || ''}`,
        `WhatsApp: ${req.whatsapp || ''}`,
        `Visa: ${req.visaCategoryLabel || ''}`,
        `Issue: ${req.issueCategoryLabel || ''}`,
        `Urgency: ${req.urgencyLabel || req.urgency || ''}`,
        `Requested: ${req.requestedSlot ? formatSlotLong(req.requestedSlot) : 'N/A'}`,
        `Confirmed: ${req.confirmedSlot ? formatSlotLong(req.confirmedSlot) : '—'}`
      ].join('\n');

      try {
        await navigator.clipboard.writeText(summary);
        showToast('Copied', 'Request summary copied to clipboard.', 'ok');
      } catch {
        showToast('Copy failed', 'Clipboard permission not available.', 'warn');
      }
    }

    /* -----------------------------
       Candidate slots for alternatives
    ------------------------------*/
    function listCandidateSlots(availability) {
      // Return available slots in the next 14 days only, sorted by date/time.
      const today = new Date();
      today.setHours(0,0,0,0);

      const max = new Date(today);
      max.setDate(max.getDate() + 14);

      const out = [];
      Object.keys(availability).forEach(dateStr => {
        const d = new Date(dateStr + 'T00:00:00');
        if (d < today || d >= max) return;

        TIMES.forEach(t => {
          const status = availability[dateStr]?.[t] || 'unavailable';
          if (status === 'available') out.push({date: dateStr, time: t});
        });
      });

      out.sort((a,b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });

      return out;
    }

    /* -----------------------------
       Date utilities / formatting
    ------------------------------*/
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatDateKey(date) {
      return date.toISOString().split('T')[0];
    }

    function formatDateShort(date) {
      return date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    }

    function formatDateTimeShort(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' ' + d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
    }

    function formatDateTimeLong(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'});
    }

    function dayNameShort(date) {
      return date.toLocaleDateString('en-US', {weekday:'short'});
    }

    function formatTime12h(time) {
      const [hours] = time.split(':');
      const h = parseInt(hours, 10);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:00 ${ampm}`;
    }

    function formatSlotShort(slot) {
      const d = new Date(slot.date + 'T00:00:00');
      return `${d.toLocaleDateString('en-US', {month:'short', day:'numeric'})} ${formatTime12h(slot.time)}`;
    }

    function formatSlotLong(slot) {
      const d = new Date(slot.date + 'T00:00:00');
      return `${d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'})} at ${formatTime12h(slot.time)}`;
    }

    function isBeforeToday(date) {
      const t = new Date();
      t.setHours(0,0,0,0);
      const d = new Date(date);
      d.setHours(0,0,0,0);
      return d < t;
    }

    /* -----------------------------
       Small UI helpers
    ------------------------------*/
    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }

    function statusLabel(status) {
      return {
        pending_approval: 'Pending Approval',
        needs_more_info: 'Needs More Info',
        alternatives_proposed: 'Alternatives Proposed',
        confirmed: 'Confirmed',
        completed: 'Completed',
        canceled: 'Canceled'
      }[status] || 'Unknown';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini2(status) {
      return {
        available: 'Available',
        unavailable: 'Unavailable',
        pending: 'Pending',
        confirmed: 'Confirmed'
      }[status] || 'Unavailable';
    }

    function statusClass(status) {
      return {
        available: 'available',
        unavailable: 'unavailable',
        pending: 'pending',
        confirmed: 'confirmed'
      }[status] || 'unavailable';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabel(status) {
      return {
        pending_approval: 'Pending Approval',
        needs_more_info: 'Needs More Info',
        alternatives_proposed: 'Alternatives Proposed',
        confirmed: 'Confirmed',
        completed: 'Completed',
        canceled: 'Canceled'
      }[status] || 'Unknown';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    function statusLabelMini(status) {
      return {
        available: 'Open',
        unavailable: 'Off',
        pending: 'Hold',
        confirmed: 'Booked'
      }[status] || 'Off';
    }

    // NOTE: The repeated definitions above appear due to fragment-merge issues in the salvaged file.
    // The final effective function definitions are the LAST ones. Keeping this section as-is prevents
    // accidental renaming/mismatch if you diff against your fragments.

    function statusLabelMiniFinal(status) {
      return { available:'Open', unavailable:'Off', pending:'Hold', confirmed:'Booked' }[status] || 'Off';
    }

    function statusLabelMini(status) { return statusLabelMiniFinal(status); }

    function statusLabelMini2(status) {
      return { available:'Available', unavailable:'Unavailable', pending:'Pending', confirmed:'Confirmed' }[status] || 'Unavailable';
    }

    function statusLabel(status) {
      return { pending_approval:'Pending Approval', needs_more_info:'Needs More Info', alternatives_proposed:'Alternatives Proposed', confirmed:'Confirmed', completed:'Completed', canceled:'Canceled' }[status] || 'Unknown';
    }

  function statusLabel(status) {
      return {
        pending_approval: 'Pending Approval',
        needs_more_info: 'Needs More Info',
        alternatives_proposed: 'Alternatives Proposed',
        confirmed: 'Confirmed',
        completed: 'Completed',
        canceled: 'Canceled'
      }[status] || 'Unknown';
    }

    /* -----------------------------
       Sync availability from requests
       (ensures pending/confirmed reflect current request states)
    ------------------------------*/
    function syncAvailabilityFromRequests() {
      const availability = getAvailability();
      const requests = getRequests();

      requests.forEach(r => {
        // Confirmed slot wins
        if (r.confirmedSlot?.date && r.confirmedSlot?.time) {
          if (!availability[r.confirmedSlot.date]) availability[r.confirmedSlot.date] = {};
          availability[r.confirmedSlot.date][r.confirmedSlot.time] = 'confirmed';
        }

        // Pending hold for requested slot if still pending approval
        if (r.status === 'pending_approval' && r.requestedSlot?.date && r.requestedSlot?.time) {
          if (!availability[r.requestedSlot.date]) availability[r.requestedSlot.date] = {};
          const cur = availability[r.requestedSlot.date][r.requestedSlot.time];
          if (cur !== 'confirmed') availability[r.requestedSlot.date][r.requestedSlot.time] = 'pending';
        }

        // If canceled and we still see a pending hold, release it
        if (r.status === 'canceled' && r.requestedSlot?.date && r.requestedSlot?.time) {
          const cur = availability?.[r.requestedSlot.date]?.[r.requestedSlot.time];
          if (cur === 'pending') availability[r.requestedSlot.date][r.requestedSlot.time] = 'available';
        }
      });

      setAvailability(availability);
    }

    // Wrap list/render so sync always happens before UI paint
    (function wrapSync() {
      const _load = loadRequests;
      loadRequests = function () {
        syncAvailabilityFromRequests();
        return _load();
      };

      const _renderAvail = renderAvailabilityGrid;
      renderAvailabilityGrid = function () {
        syncAvailabilityFromRequests();
        return _renderAvail();
      };
    })();

    /* -----------------------------
       Escaping helpers
    ------------------------------*/
    function escapeHtml(input) {
      const s = String(input ?? '');
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function escapeAttr(input) {
      // For attributes; keep it strict
      return escapeHtml(input).replace(/`/g, '&#96;');
    }

    /* -----------------------------
       Toast helpers
    ------------------------------*/
    let toastTimer = null;

    function showToast(title, msg, kind = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const t = document.getElementById('toast-title');
      const m = document.getElementById('toast-msg');

      if (!toast || !icon || !t || !m) return;

      t.textContent = title || 'Notice';
      m.textContent = msg || '';

      icon.classList.remove('ok', 'warn', 'info');
      if (kind === 'ok') icon.classList.add('ok');
      else if (kind === 'warn') icon.classList.add('warn');
      else icon.classList.add('info');

      toast.classList.add('show');

      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => hideToast(), 3500);
    }

    function hideToast() {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.classList.remove('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = null;
    }

    /* -----------------------------
       Misc
    ------------------------------*/
    function lockBodyScroll(lock) {
      document.body.style.overflow = lock ? 'hidden' : '';
    }

    // Run one sync + paint pass if this was appended after initial load.
    try {
      syncAvailabilityFromRequests();
      if (typeof loadRequests === 'function') loadRequests();
      if (typeof renderAvailabilityGrid === 'function') renderAvailabilityGrid();
    } catch (e) {
      // no-op
    }
  </script>
</body>
</html>
